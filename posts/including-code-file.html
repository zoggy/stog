<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta content="application/xhtml+xml; charset=utf-8" http-equiv="Content-Type"/>
<title>Stog : Including a code file (deferring evaluation)</title>
<link href="https://zoggy.github.io/stog/style.css" rel="stylesheet" type="text/css"/>
</head>
<script type="text/javascript">
function submitSearch(){
    var q = document.getElementById('q');
    q.value =q.value + " site:https://zoggy.github.io/stog ";
    return true;
}
</script>
<body>
<div id="page">
<div class="navbar navbar-fixed-top">
<div class="navbar-inner">
<div class="container">

<!--&lt;image float="right" src="&lt;site-url/&gt;/stog-logo.svg" width="30"/&gt;-->

  <div class="nav-collapse">
    <ul class="nav">
    <li class="&lt;navbar-home/&gt;"><a href="https://zoggy.github.io/stog/index.html">Stog</a></li>
    <li class="&lt;navbar-install/&gt;"><a href="https://zoggy.github.io/stog/install.html">Installation</a></li>
    <li class="&lt;navbar-doc/&gt;"><a href="https://zoggy.github.io/stog/doc.html">Documentation</a></li>
    <li class="&lt;navbar-plugins/&gt;"><a href="https://zoggy.github.io/stog/plugins.html">Plugins</a></li>
    <li class="active"><a href="https://zoggy.github.io/stog/blog.html">Blog</a></li>
    <li class="&lt;navbar-about/&gt;"><a href="https://zoggy.github.io/stog/about.html">?</a></li>
    </ul>
<!--
    &lt;div class="nav pull-right"&gt;
       &lt;form action="https://qwant.com/" method="GET"
         onsubmit="submitSearch();"
         style="overflow:hidden;margin:0;margin-top:5px;padding:0;height:28px;display:flex;"
         frameborder="0"&gt;
         &lt;input style="width: 100px;" type="text" id="q" placeHolder="Search" name="q"/&gt;
         &lt;input style="font-size: 0.8em" type="submit" value="ðŸ”Ž"/&gt;
       &lt;/form&gt;
    &lt;/div&gt;
-->
  </div>

</div>
</div>
</div>

<div id="header">
  
  
  <div class="doc-navbar">
      <div class="navleft"><a href="https://zoggy.github.io/stog/posts/displaying-evaluated-ocaml-code.html">Displaying evaluated OCaml code</a></div>
      <div class="navright"><a href="https://zoggy.github.io/stog/posts/release-0.1.html">Stog 0.1</a></div>
    </div>
  <div class="page-title">Including a code file (deferring evaluation)</div>
</div>

<div class="date">March 13, 2012</div>


<p>How to highlight a file inserted with <span class="icode"><span class="hl kwa">&lt;include</span><span class="hl std"> ...</span><span class="hl kwa">&gt;</span></span> ?
</p>

<p>
If you want to include and highlight for example the <span class="icode"><span class="hl std">../src/plugins/stog_disqus.ml</span></span> file
relative to your project directory, you can try
<pre class="code-xml"><span class="hl kwa">&lt;hcode</span><span class="hl std"> </span><span class="">raw</span><span class="hl std">=</span><span class="hl str">"true"</span><span class="hl std"> </span><span class="">lang</span><span class="hl std">=</span><span class="hl str">"ocaml"</span><span class="hl kwa">&gt;</span><span class="hl kwa">&lt;include</span><span class="hl std"> </span><span class="">file</span><span class="hl std">=</span><span class="hl str">"../src/plugins/stog_disqus.ml"</span><span class="hl kwa">/&gt;</span><span class="hl kwa">&lt;/hcode</span><span class="hl kwa">&gt;</span></pre>
but this will only result in
<pre class="code-ocaml"><span class="hl std">&lt;</span><span class="hl kwa">include</span><span class="hl std"> </span><span class="">file</span><span class="hl std">=</span><span class="hl str">"../../plugins/stog_disqus.ml"</span><span class="hl std"> </span><span class="">raw</span><span class="hl std">=</span><span class="hl str">"true"</span><span class="hl std">/&gt;</span></pre>
</p>
<p>This is because <span class="icode"><span class="hl std">&lt;hcode...&gt;</span></span> is evaluated immediately, displaying
its children nodes. What you need is to defer the evaluation of <span class="icode"><span class="hl std">&lt;hcode...&gt;</span></span>,
using the special <span class="icode"><span class="hl std">defer_</span></span> attribute:
<pre class="code-xml"><span class="hl kwa">&lt;hcode</span><span class="hl std"> </span><span class="">raw</span><span class="hl std">=</span><span class="hl str">"true"</span><span class="hl std"> </span><span class="">lang</span><span class="hl std">=</span><span class="hl str">"ocaml"</span><span class="hl std"> </span><span class="">defer_</span><span class="hl std">=</span><span class="hl str">"1"</span><span class="hl kwa">&gt;</span><span class="hl kwa">&lt;include</span><span class="hl std"> </span><span class="">file</span><span class="hl std">=</span><span class="hl str">"../src/plugins/stog_disqus.ml"</span><span class="hl kwa">/&gt;</span><span class="hl kwa">&lt;/hcode</span><span class="hl kwa">&gt;</span></pre>
This will give the expected result:
<pre class="code-ocaml"><span class="hl com">(*********************************************************************************)
(*                Stog                                                           *)</span><span class="hl std">
</span><span class="hl com">(*                                                                               *)</span><span class="hl std">
</span><span class="hl com">(*    Copyright (C) 2012-2015 INRIA All rights reserved.                         *)</span><span class="hl std">
</span><span class="hl com">(*    Author: Maxence Guesdon, INRIA Saclay                                      *)</span><span class="hl std">
</span><span class="hl com">(*                                                                               *)</span><span class="hl std">
</span><span class="hl com">(*    This program is free software; you can redistribute it and/or modify       *)</span><span class="hl std">
</span><span class="hl com">(*    it under the terms of the GNU General Public License as                    *)</span><span class="hl std">
</span><span class="hl com">(*    published by the Free Software Foundation, version 3 of the License.       *)</span><span class="hl std">
</span><span class="hl com">(*                                                                               *)</span><span class="hl std">
</span><span class="hl com">(*    This program is distributed in the hope that it will be useful,            *)</span><span class="hl std">
</span><span class="hl com">(*    but WITHOUT ANY WARRANTY; without even the implied warranty of             *)</span><span class="hl std">
</span><span class="hl com">(*    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the               *)</span><span class="hl std">
</span><span class="hl com">(*    GNU General Public License for more details.                               *)</span><span class="hl std">
</span><span class="hl com">(*                                                                               *)</span><span class="hl std">
</span><span class="hl com">(*    You should have received a copy of the GNU General Public                  *)</span><span class="hl std">
</span><span class="hl com">(*    License along with this program; if not, write to the Free Software        *)</span><span class="hl std">
</span><span class="hl com">(*    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA                   *)</span><span class="hl std">
</span><span class="hl com">(*    02111-1307  USA                                                            *)</span><span class="hl std">
</span><span class="hl com">(*                                                                               *)</span><span class="hl std">
</span><span class="hl com">(*    As a special exception, you have permission to link this program           *)</span><span class="hl std">
</span><span class="hl com">(*    with the OCaml compiler and distribute executables, as long as you         *)</span><span class="hl std">
</span><span class="hl com">(*    follow the requirements of the GNU GPL in regard to all of the             *)</span><span class="hl std">
</span><span class="hl com">(*    software in the executable aside from the OCaml compiler.                  *)</span><span class="hl std">
</span><span class="hl com">(*                                                                               *)</span><span class="hl std">
</span><span class="hl com">(*    Contact: Maxence.Guesdon@inria.fr                                          *)</span><span class="hl std">
</span><span class="hl com">(*                                                                               *)</span><span class="hl std">
(*********************************************************************************)

</span><span class="hl kwa">open</span><span class="hl std"> </span><span class="hl kwc">Stog_types</span><span class="hl std">;;

</span><span class="hl kwa">let</span><span class="hl std"> </span><span class="">fun_comments</span><span class="hl std"> </span><span class="">stog</span><span class="hl std"> </span><span class="">env</span><span class="hl std"> ?</span><span class="">loc</span><span class="hl std"> </span><span class="">args</span><span class="hl std"> </span><span class="">subs</span><span class="hl std"> =
  </span><span class="hl kwa">let</span><span class="hl std"> (</span><span class="">stog</span><span class="hl std">, </span><span class="">path</span><span class="hl std">) = </span><span class="hl kwc">Stog_engine</span><span class="hl std">.</span><span class="">get_path</span><span class="hl std"> </span><span class="">stog</span><span class="hl std"> </span><span class="">env</span><span class="hl std"> </span><span class="hl kwa">in</span><span class="hl std">
  </span><span class="hl kwa">let</span><span class="hl std"> (</span><span class="hl num">_</span><span class="hl std">, </span><span class="">doc</span><span class="hl std">) = </span><span class="hl kwc">Stog_types</span><span class="hl std">.</span><span class="">doc_by_path</span><span class="hl std"> </span><span class="">stog</span><span class="hl std"> </span><span class="">path</span><span class="hl std"> </span><span class="hl kwa">in</span><span class="hl std">
  </span><span class="hl kwa">let</span><span class="hl std"> </span><span class="">tmpl</span><span class="hl std"> = </span><span class="hl kwc">Stog_tmpl</span><span class="hl std">.</span><span class="">get_template_file</span><span class="hl std"> </span><span class="">stog</span><span class="hl std"> </span><span class="">doc</span><span class="hl std"> ?</span><span class="">loc</span><span class="hl std"> </span><span class="hl str">"disqus.tmpl"</span><span class="hl std"> </span><span class="hl kwa">in</span><span class="hl std">
  </span><span class="hl kwc">Xtmpl_rewrite</span><span class="hl std">.</span><span class="">apply_to_file</span><span class="hl std"> </span><span class="">stog</span><span class="hl std"> </span><span class="">env</span><span class="hl std"> </span><span class="">tmpl</span><span class="hl std">
;;

</span><span class="hl kwa">let</span><span class="hl std"> () = </span><span class="hl kwc">Stog_plug</span><span class="hl std">.</span><span class="">register_html_base_rule</span><span class="hl std"> (</span><span class="hl str">""</span><span class="hl std">, </span><span class="hl str">"comments"</span><span class="hl std">) </span><span class="">fun_comments</span><span class="hl std">;;
</span></pre>
</p>
<p>
The <span class="icode"><span class="hl std">defer_</span></span> attribute is decremented each time the node should be evaluated.
So the first time, the value is 1, so the children are evaluated first, then the
<span class="icode"><span class="hl std">&lt;hcode&gt;</span></span> node is returned with a <span class="icode"><span class="hl std">defer_</span></span> attribute
decremented, i.e. 0, and with the result of <span class="icode"><span class="hl std">&lt;include ...&gt;</span></span>
as children. During the next evaluation, the <span class="icode"><span class="hl std">&lt;hcode&gt;</span></span> is evaluated
and it now highlights its children, that is the contents of the included file.
</p>
<p><span class="icode"><span class="hl std">defer_</span></span> can take values greater than 1, if you need to nest deferred evaluations.</p>






<p class="doccode alert alert-info">
For information you can see the <a href="#pagesource"> source code of the page</a>.
</p>
<div id="pagesource">
  <pre class="code-xml"><span class="hl kwa">&lt;post</span><span class="hl std"> </span><span class="">title</span><span class="hl std">=</span><span class="hl str">"Including a code file (deferring evaluation)"</span><span class="hl std">
</span><span class="">date</span><span class="hl std">=</span><span class="hl str">"2012/03/13"</span><span class="hl std">
</span><span class="">topics</span><span class="hl std">=</span><span class="hl str">"stog"</span><span class="hl std">
</span><span class="">keywords</span><span class="hl std">=</span><span class="hl str">"highlight, include, code"</span><span class="hl std">
</span><span class="">published</span><span class="hl std">=</span><span class="hl str">"true"</span><span class="hl std">
</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">How to highlight a file inserted with </span><span class="hl kwa">&lt;icode</span><span class="hl std"> </span><span class="">lang</span><span class="hl std">=</span><span class="hl str">"xml"</span><span class="hl kwa">&gt;</span><span class="hl kwb">&amp;lt;</span><span class="hl std">include ...</span><span class="hl kwb">&amp;gt;</span><span class="hl kwa">&lt;/icode</span><span class="hl kwa">&gt;</span><span class="hl std"> ?
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;sep_</span><span class="hl kwa">/&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">
If you want to include and highlight for example the </span><span class="hl kwa">&lt;icode</span><span class="hl kwa">&gt;</span><span class="hl std">../src/plugins/stog_disqus.ml</span><span class="hl kwa">&lt;/icode</span><span class="hl kwa">&gt;</span><span class="hl std"> file
relative to your project directory, you can try
</span><span class="hl kwa">&lt;hcode</span><span class="hl std"> </span><span class="">lang</span><span class="hl std">=</span><span class="hl str">"xml"</span><span class="hl kwa">&gt;</span><span class="hl std">&lt;![CDATA[</span><span class="hl kwa">&lt;hcode</span><span class="hl std"> </span><span class="">raw</span><span class="hl std">=</span><span class="hl str">"true"</span><span class="hl std"> </span><span class="">lang</span><span class="hl std">=</span><span class="hl str">"ocaml"</span><span class="hl kwa">&gt;</span><span class="hl kwa">&lt;include</span><span class="hl std"> </span><span class="">file</span><span class="hl std">=</span><span class="hl str">"../src/plugins/stog_disqus.ml"</span><span class="hl kwa">/&gt;</span><span class="hl kwa">&lt;/hcode</span><span class="hl kwa">&gt;</span><span class="hl std">]]&gt;</span><span class="hl kwa">&lt;/hcode</span><span class="hl kwa">&gt;</span><span class="hl std">
but this will only result in
</span><span class="hl kwa">&lt;hcode</span><span class="hl std"> </span><span class="">lang</span><span class="hl std">=</span><span class="hl str">"ocaml"</span><span class="hl kwa">&gt;</span><span class="hl kwa">&lt;include</span><span class="hl std"> </span><span class="">raw</span><span class="hl std">=</span><span class="hl str">"true"</span><span class="hl std"> </span><span class="">file</span><span class="hl std">=</span><span class="hl str">"../../plugins/stog_disqus.ml"</span><span class="hl kwa">/&gt;</span><span class="hl kwa">&lt;/hcode</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">This is because </span><span class="hl kwa">&lt;icode</span><span class="hl kwa">&gt;</span><span class="hl kwb">&amp;lt;</span><span class="hl std">hcode...</span><span class="hl kwb">&amp;gt;</span><span class="hl kwa">&lt;/icode</span><span class="hl kwa">&gt;</span><span class="hl std"> is evaluated immediately, displaying
its children nodes. What you need is to defer the evaluation of </span><span class="hl kwa">&lt;icode</span><span class="hl kwa">&gt;</span><span class="hl kwb">&amp;lt;</span><span class="hl std">hcode...</span><span class="hl kwb">&amp;gt;</span><span class="hl kwa">&lt;/icode</span><span class="hl kwa">&gt;</span><span class="hl std">,
using the special </span><span class="hl kwa">&lt;icode</span><span class="hl kwa">&gt;</span><span class="hl std">defer_</span><span class="hl kwa">&lt;/icode</span><span class="hl kwa">&gt;</span><span class="hl std"> attribute:
</span><span class="hl kwa">&lt;hcode</span><span class="hl std"> </span><span class="">lang</span><span class="hl std">=</span><span class="hl str">"xml"</span><span class="hl kwa">&gt;</span><span class="hl std">&lt;![CDATA[</span><span class="hl kwa">&lt;hcode</span><span class="hl std"> </span><span class="">raw</span><span class="hl std">=</span><span class="hl str">"true"</span><span class="hl std"> </span><span class="">lang</span><span class="hl std">=</span><span class="hl str">"ocaml"</span><span class="hl std"> </span><span class="">defer_</span><span class="hl std">=</span><span class="hl str">"1"</span><span class="hl kwa">&gt;</span><span class="hl kwa">&lt;include</span><span class="hl std"> </span><span class="">file</span><span class="hl std">=</span><span class="hl str">"../src/plugins/stog_disqus.ml"</span><span class="hl kwa">/&gt;</span><span class="hl kwa">&lt;/hcode</span><span class="hl kwa">&gt;</span><span class="hl std">]]&gt;</span><span class="hl kwa">&lt;/hcode</span><span class="hl kwa">&gt;</span><span class="hl std">
This will give the expected result:
</span><span class="hl kwa">&lt;hcode</span><span class="hl std"> </span><span class="">lang</span><span class="hl std">=</span><span class="hl str">"ocaml"</span><span class="hl std"> </span><span class="">defer_</span><span class="hl std">=</span><span class="hl str">"1"</span><span class="hl kwa">&gt;</span><span class="hl kwa">&lt;include</span><span class="hl std"> </span><span class="">raw</span><span class="hl std">=</span><span class="hl str">"true"</span><span class="hl std"> </span><span class="">file</span><span class="hl std">=</span><span class="hl str">"../../src/plugins/stog_disqus.ml"</span><span class="hl kwa">/&gt;</span><span class="hl kwa">&lt;/hcode</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl std">
The </span><span class="hl kwa">&lt;icode</span><span class="hl kwa">&gt;</span><span class="hl std">defer_</span><span class="hl kwa">&lt;/icode</span><span class="hl kwa">&gt;</span><span class="hl std"> attribute is decremented each time the node should be evaluated.
So the first time, the value is 1, so the children are evaluated first, then the
</span><span class="hl kwa">&lt;icode</span><span class="hl kwa">&gt;</span><span class="hl kwb">&amp;lt;</span><span class="hl std">hcode</span><span class="hl kwb">&amp;gt;</span><span class="hl kwa">&lt;/icode</span><span class="hl kwa">&gt;</span><span class="hl std"> node is returned with a </span><span class="hl kwa">&lt;icode</span><span class="hl kwa">&gt;</span><span class="hl std">defer_</span><span class="hl kwa">&lt;/icode</span><span class="hl kwa">&gt;</span><span class="hl std"> attribute
decremented, i.e. 0, and with the result of </span><span class="hl kwa">&lt;icode</span><span class="hl kwa">&gt;</span><span class="hl kwb">&amp;lt;</span><span class="hl std">include ...</span><span class="hl kwb">&amp;gt;</span><span class="hl kwa">&lt;/icode</span><span class="hl kwa">&gt;</span><span class="hl std">
as children. During the next evaluation, the </span><span class="hl kwa">&lt;icode</span><span class="hl kwa">&gt;</span><span class="hl kwb">&amp;lt;</span><span class="hl std">hcode</span><span class="hl kwb">&amp;gt;</span><span class="hl kwa">&lt;/icode</span><span class="hl kwa">&gt;</span><span class="hl std"> is evaluated
and it now highlights its children, that is the contents of the included file.
</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;p</span><span class="hl kwa">&gt;</span><span class="hl kwa">&lt;icode</span><span class="hl kwa">&gt;</span><span class="hl std">defer_</span><span class="hl kwa">&lt;/icode</span><span class="hl kwa">&gt;</span><span class="hl std"> can take values greater than 1, if you need to nest deferred evaluations.</span><span class="hl kwa">&lt;/p</span><span class="hl kwa">&gt;</span><span class="hl std">
</span><span class="hl kwa">&lt;/post</span><span class="hl kwa">&gt;</span></pre>
</div>

<div id="footer">
<div class="generatedon">Generated on November 30, 2016 at 12h27</div>
</div>
<!--&lt;script type="text/javascript" src="&lt;site-url/&gt;/jquery.js"&gt;_&lt;/script&gt;-->
<!--&lt;script type="text/javascript" src="&lt;site-url/&gt;/bootstrap-collapse.js"&gt;_&lt;/script&gt;-->

</div> <!-- #page -->
</body>
</html>
